---
title: "USB固件与驱动"
date: "2024-03-26" # 格式为 YYYY-MM-DD
categories: DmZi
tags:
  - 外设接口
  - 通信技术
summary: "USB只提供传输，而上下位机还需要驱动和固件才能让USB为引用程序所用"
author: "ChatGPT"
---

# USB固件与驱动

## 固件和驱动的区别及其存在位置

**固件（Firmware）**：
- **定义**：固件是**嵌入到硬件设备中的软件**，用于控制该设备的低级功能。它提供了硬件操作必需的指令，使设备能够执行基本的输入输出操作并与其他设备通信。
- **存在位置**：固件通常**存储在硬件设备的非易失性存储器中**，如ROM（只读存储器）、EPROM（可擦写可编程只读存储器）或闪存。在您的场景中，固件被烧写到了USB芯片（CYUSB3014-BZXI）内部的存储器中，使其能够按照特定方式处理USB通信。

**驱动（Driver）**：
- **定义**：驱动是一种软件，它允许操作系统和硬件设备之间进行通信。它**提供了一种方式**，使得操作系统能够通过**定义良好的软件接口**发送指令给硬件设备，而无需了解硬件的具体实现细节。
- **存在位置**：驱动程序安装在计算机的操作系统上，通常**存放在硬盘驱动器或固态硬盘中**。在您的例子中，通过「Zadig」软件给USB设备下载驱动，实际上是在计算机操作系统上安装了使其能够识别和通信的软件。


## 必要性 

### 驱动程序的必要性

操作系统确实提供了USB的基础支持，包括能够识别和通用控制USB设备的能力。这是通过操作系统内置的通用USB驱动和接口实现的，它们确实相当于网络通信中的基础层。这种设计允许任何USB设备至少被操作系统识别，实现基本的数据传输。

**为什么需要特定的驱动程序**：
- **设备特异性**：每种USB设备（如打印机、摄像头、存储设备）都有其特定的功能和通信需求。**通用的USB接口无法完全满足所有特定设备的高级功能需求**。特定的驱动程序能够提供设备特有的控制和数据处理能力，使设备能够以最优方式工作。
- **性能优化**：特定设备的驱动程序可以针对该设备的硬件特性进行优化，提高数据传输的效率和速度。
- **增加新功能**：驱动程序可以为硬件设备添加操作系统原生不支持的新功能。

因此，驱动程序的作用在于桥接操作系统的通用接口与特定硬件的专有通信需求之间，**提供了一种可扩展、高性能、定制化的通信方式**。

### 固件的必要性

USB标准定义了一种通信协议，确保了设备之间的基本兼容性。但是，**USB协议本身并不规定硬件如何在电气或物理层面实现这些协议的细节**。固件在这里起到了关键作用。

**为什么需要固件**：
- **设备控制**：固件能够直接控制硬件的行为，包括数据处理、电源管理、错误处理等。这为设备操作提供了必要的灵活性和控制能力。
- **协议实现**：虽然USB是一个通用协议，但是**不同设备可能需要通过不同方式实现这一协议**。固件使得设备能够以正确的方式响应USB请求，执行数据传输等操作。
- **自定义和扩展**：固件允许制造商在不改变硬件的情况下，通过软件更新来改进设备功能或修正错误。

如果没有固件，USB设备可能无法正常运行，因为它们缺乏**执行基本操作所需的指令集和控制逻辑**。固件是使USB设备能够按照USB标准和设备特定需求运作的关键组成部分。



## 外设通过USB接口与计算机通信的流程

1. **应用程序与驱动程序的通信**：
   - 应用程序通过操作系统提供的API（应用程序编程接口）发出通信请求。这些API抽象了底层硬件的复杂性，使得开发人员可以不需要深入了解硬件细节就能编写软件。
   - 当应用程序需要与USB设备通信时，它会通过操作系统寻找相应的驱动程序。操作系统使用设备的识别信息（如供应商ID和产品ID）来匹配正确的驱动程序。

2. **驱动程序与操作系统的交互**：
   - **驱动程序接收来自应用程序的请求，并负责将这些请求转换成硬件可以理解的命令**。驱动程序还负责管理数据的传输，包括处理可能发生的任何错误。
   - 驱动程序使用操作系统提供的接口与USB控制器通信，执行如数据传输、状态查询等操作。

3. **USB芯片的角色**：
   - USB芯片根据其固件中的指令来处理来自PC的数据和命令。**固件决定了如何识别和响应USB请求，以及如何与连接的FPGA通信。**
   - 固件还负责处理USB协议的细节，例如数据包的组装和解析，错误检测和纠正，以及流量控制。

4. **与FPGA的通信**：
   - 一旦USB芯片接收并处理了来自PC的数据，它会通过一个预定义的接口（如SPI、I2C或直接并行接口）将数据传输给FPGA。
   - FPGA根据接收到的数据执行相应的操作。这些操作可能包括数据处理、控制逻辑操作，或者将结果数据通过相同或不同的接口发送回USB芯片。

5. **数据返回流程**：
   - 如果操作涉及将数据从FPGA返回给PC，这一过程会反向进行。FPGA将数据发送给USB芯片，USB芯片通过其固件处理数据，然后通过USB接口将数据发送回PC。PC上的驱动程序接收数据，并将其传递给发起请求的应用程序。

这个过程展示了一个从PC应用程序到硬件设备（通过USB接口和FPGA）的完整通信链路，每个步骤都需要精确的协调以确保数据准确无误地传输。通过这样的设计，开发者能够充分利用USB接口的高通用性和FPGA的灵活性，为复杂的硬件系统提供强大的支持。



## USB设备的识别和安装驱动

### USB设备识别和驱动加载流程

当您将电路板（USB设备）插入计算机时，会发生以下步骤：

1. **设备枚举（Enumeration）**：USB设备被连接到计算机时，操作系统的USB控制器会识别到新设备的接入，并开始一个称为枚举的过程。在这个过程中，USB控制器向设备请求一系列的描述符。

2. **设备描述符**：这些描述符包括设备的名称、类型（设备类）、制造商ID、产品ID等信息。这些信息存储**在USB设备的固件中，作为设备自我描述的一部分**。操作系统通过读取这些描述符来识别设备和确定如何与之通信。

3. **驱动程序的匹配和加载**：一旦操作系统获取了设备的描述符，它会在系统中查找合适的驱动程序。如果系统已经有适用的驱动，它会自动加载。如果没有找到匹配的驱动，系统可能会提示用户安装驱动，或者用户可以通过工具（如Zadig）手动选择并安装驱动。


### 驱动程序只对特定USB端口有效的原因

您遇到的情况，即通过Zadig安装的驱动程序仅对特定USB端口有效，当设备插到其他端口时需要重新安装驱动，这反映了USB设备在操作系统中的识别和管理机制。这可能由以下因素造成：

- **端口级别的设备识别**：某些操作系统在处理USB设备时，会将设备与其连接的特定端口信息关联起来。这意味着，即使是同一设备，当它被连接到不同的USB端口时，操作系统可能会将其视为新设备，并重新进行设备枚举和驱动匹配过程。

- **安全和配置原因**：这种设计可以让操作系统为每个USB端口提供不同的安全级别或配置设置，增加了灵活性。但同时，它也意味着驱动程序可能需要为同一设备在不同端口的每次连接重新安装或配置。

- **设备实例识别**：当USB设备首次连接到新端口时，操作系统创建一个新的设备实例，这包括为该特定连接实例分配资源和加载驱动。这样做的目的是确保设备的正确配置和优化性能。

综上所述，当您的电路板首次连接到电脑时，操作系统通过枚举过程读取设备固件中的描述符来识别设备并准备驱动程序。而驱动程序只对特定USB端口有效的行为，是由于操作系统为了提高灵活性和安全性，对每个端口的设备连接进行单独管理和识别所致。这种设计既有其优势，也带来了一些用户在使用过程中需要重新安装驱动的不便。


### 安装驱动

电路板上的USB设备可能不属于操作系统内置驱动支持的常见设备类别（如打印机、键盘、鼠标等），因此它需要特定的驱动程序来实现与计算机的通信。

操作系统会根据USB设备提供的描述信息（包括设备类型、制造商ID、产品ID等）来识别设备，并尝试在已安装的驱动程序数据库中找到一个合适的驱动程序。如果操作系统内置的驱动库中没有合适的驱动能够支持该设备，或者为了实现设备的全部功能和性能需要特定的驱动程序，那么用户就需要手动安装相应的驱动。这就是使用如Zadig这样的工具手动选择并安装适当的驱动程序的原因。

此外，特定的驱动程序可以提供设备特有的控制和数据处理能力，使设备能够以最优方式工作。例如，在您的情况下，操作系统可能没有内置支持FPGA或特定USB控制器（如CYUSB3014-BZXI）的驱动，因此需要通过Zadig等工具安装合适的驱动程序来确保设备的正确识别和功能实现。这种方式允许您的电路板与计算机高效地通信，实现所需的特定应用程序功能。


## 「自带」驱动的设备

USB设备可以设计成“自带”驱动程序，这种机制通常被称为“驱动程序自动加载”或“零配置安装”。这是通过一种称为USB类驱动（USB class driver）的通用驱动支持实现的，或者通过设备的特定设计，使其在第一次连接到计算机时能够自动安装所需的驱动程序。这里有几种不同的方式来实现这一点：

### USB类驱动支持
许多USB设备属于某些标准类别，如存储设备（U盘）、图像捕捉设备（网络摄像头）、打印机等。对于这些设备，操作系统提供了预装的类驱动程序。当这些设备被连接到计算机时，操作系统可以立即识别设备所属的类别，并自动加载相应的类驱动程序，无需用户手动安装。

### 自带驱动程序的设备
某些设备在其固件中内置了一小部分驱动程序或安装程序，或者在设备的存储空间中预装了驱动程序。当这些设备首次连接到计算机时，它们可以模拟一个标准的USB存储设备，操作系统识别后将自动运行设备提供的安装程序来安装所需的驱动程序。这一过程对用户来说是透明的，给人的感觉就像设备“自带”了驱动程序一样。

### 操作系统的智能匹配
现代操作系统（如Windows 10及更高版本）具有高度发达的硬件识别和驱动程序管理能力。当操作系统无法在本地找到合适的驱动程序时，它会尝试通过网络搜索并自动下载适合的驱动程序。这种机制进一步减少了用户需要手动安装驱动程序的情况。

### 特例
即使对于一些看似具有特异功能的设备，如果它们的功能可以通过标准的USB类（如HID类用于人机交互设备）或者操作系统已有的通用驱动程序来实现，那么这些设备也可能无需用户手动安装特定的驱动程序即可工作。

总之，虽然某些USB设备似乎“自带”了驱动程序或不需要用户手动安装驱动程序就能工作，这实际上是因为这些设备利用了USB类驱动支持、设备内置驱动程序的自动安装机制，或者操作系统的智能驱动程序匹配和自动下载功能。这些机制共同提高了用户体验，使得连接新设备变得更加方便和快捷。


## 通用USB驱动
**libusb:**
libusb是一个轻量级的用户空间USB驱动库，支持跨平台操作系统，如Windows、Linux和macOS。它允许开发者直接访问USB设备，而不需要了解操作系统底层的USB协议。通过libusb，开发者可以实现各种类型的USB设备驱动程序，并进行USB设备的读写操作、控制和配置。libusb提供了一种简单而灵活的方法来开发USB设备驱动程序，使得USB设备的开发过程更加方便和高效。

**libusbK:**
libusbK是一个通用的USB驱动程序库，与libusb类似，但它专注于Windows系统。libusbK允许开发者直接访问USB设备，并提供了在Windows平台上进行USB设备驱动开发的功能。与其他USB驱动程序库相比，libusbK的一个特点是其对于Windows内核模式驱动程序的支持，这使得它可以实现更高级别的控制和性能优化。通过libusbK，开发者可以实现各种类型的USB设备，包括但不限于存储设备、人机交互设备等。

**WinUSB:**
WinUSB是Windows提供的一种用户模式的USB驱动程序框架。它允许应用程序直接与USB设备进行通信，而无需编写内核模式驱动程序。WinUSB通常用于Windows系统上的USB设备驱动开发，它提供了一种简化的方法来创建USB设备驱动程序，并支持各种类型的USB设备，包括但不限于存储设备、人机交互设备等。

**usbfs (USB Filesystem):**
usbfs是Linux内核提供的一种文件系统，允许用户空间应用程序通过文件I/O操作来访问USB设备。用户可以通过在/sys/bus/usb/devices目录下找到的设备文件来进行读写操作。usbfs为Linux系统上的USB设备访问提供了一种简便的方式，但它通常需要用户具有足够的权限来进行设备访问和操作。

**USB Human Interface Device (HID):**
USB Human Interface Device (HID)是一种通用的USB设备类别，用于连接鼠标、键盘、游戏手柄等人机交互设备。大多数操作系统都内置了对HID设备的驱动支持，这使得HID设备的开发相对简单。作为一种广泛应用的USB设备类别，HID设备在各种计算机和嵌入式系统中都有着重要的作用。

**USB Mass Storage Class (MSC):**
USB Mass Storage Class (MSC)是一种通用的USB设备类别，用于连接闪存驱动器、外置硬盘、SD卡等存储设备。大多数操作系统也内置了对MSC设备的驱动支持，这使得MSC设备可以被简单地插入并使用，无需安装额外的驱动程序。作为一种常见的USB设备类型，MSC设备在数据存储和传输方面有着广泛的应用。
