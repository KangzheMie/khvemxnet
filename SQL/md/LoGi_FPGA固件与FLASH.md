---
title: "FPGA固件与FLASH"
date: "2024-04-11" # 格式为 YYYY-MM-DD
categories: LoGi
tags:
  - 外设接口
  - 通信技术
summary: "软件生成固件的格式以及FLASH上电配置的过程"
author: "ChatGPT"
---

# FPGA固件与FLASH
## FPGA固件的格式
在Vivado中，完成设计后生成的.bit文件是FPGA配置的直接产物。这个文件可以被进一步转换成不同的格式，用于不同的配置需求或设备。提到的MCS、BIN和HEX格式，实际上各有其适用场景。

1. **MCS (Memory Configuration File)**: MCS文件格式主要用于存储配置数据，特别是当使用SPI闪存或其他非易失性存储器件对FPGA进行配置时。它是一种标准的JEDEC格式，适合于多数编程器和测试设备。因此，如果的FPGA配置流程涉及到将配置数据烧录到一个外部的存储器件中，MCS格式是非常合适的选择。

2. **BIN (Binary File)**: BIN文件格式是一种非常直接的表示形式，它仅包含原始的二进制数据。这种格式的文件体积相对较小，因为它不包含任何额外的元数据或格式化信息。BIN文件可以直接被用于通过JTAG接口对FPGA进行配置，或者在某些情况下被写入到非易失性存储设备中。这是一个更加底层和灵活的格式。

3. **HEX (Hexadecimal File)**: HEX文件格式将二进制数据以十六进制形式表示。这种格式常见于微控制器编程和某些类型的存储器配置中。尽管在FPGA配置中不如MCS或BIN格式常见，HEX文件仍然可以被用于特定的配置流程，尤其是当目标设备或工具链对十六进制数据有特定需求时。

### BIN格式

如果将BIN格式的文件存储在FLASH中，系统仍然可以正常加载逻辑到FPGA中，前提是该过程正确执行。

FPGA加载逻辑的过程涉及到从一个非易失性存储器件（如SPI FLASH）中读取配置数据，并将其加载到FPGA的配置存储单元中。这个过程是由FPGA的启动序列控制的，该序列根据FPGA的配置引脚和启动模式来确定从哪个源加载配置数据。当使用BIN文件作为配置数据时，实际上是在提供一个纯粹的二进制表示的配置位流，这是FPGA能够直接理解和加载的。

然而，要使这个过程成功，需要确保几个关键点：

1. **正确的文件格式**：确保BIN文件没有损坏，且确实符合的FPGA配置需求。
2. **正确的加载方式**：FPGA的启动模式需要设置为从存储BIN文件的那个FLASH启动。
3. **适当的接线**：FLASH与FPGA之间的物理连接需要正确无误，以确保数据能够被顺利传输。
4. **适合的工具和流程**：在将BIN文件烧录到FLASH之前，需要使用适当的工具和流程，确保文件被正确地写入。

总之，只要上述条件得到满足，使用BIN格式的文件存储在FLASH中的配置数据能够被FPGA正确加载。实际上，这种方法因其简洁高效而在某些应用场景中非常受欢迎。不过，请记住，这需要对FPGA的启动过程和存储设备有深入的了解。

### MCS格式
使用MCS格式存储在FLASH中对FPGA配置来说有几个明显的优势：

1. **兼容性和标准化**：MCS（Memory Configuration File）格式是一种广泛使用的标准，特别是在用于非易失性存储设备如SPI FLASH时。这种格式的文件不仅仅是原始的二进制数据，它还包含了额外的元数据和格式信息，这使得它能够被广泛的编程器和硬件支持。这种兼容性和标准化简化了配置流程，使得从不同的供应商那里获取工具和资源变得更加容易。

2. **错误检查和验证**：由于MCS文件包含额外的校验信息，它可以提供错误检查能力，确保数据在编程过程中没有损坏。这是一个重要的优势，因为它可以提高配置流程的可靠性，减少因配置数据错误导致的失败率。

3. **地址定位**：MCS文件格式支持数据的地址定位，这意味着您可以将配置数据精确地写入FLASH存储器的指定位置。这对于在同一存储器中存储多个配置文件或其他数据类型非常有用，因为它允许您管理和访问这些数据的布局。

4. **易于管理**：对于需要更新或管理存储在FLASH中的配置数据的场景，MCS格式的文件由于其结构化和包含元数据的特性，使得这些操作更加直观和容易执行。例如，在需要远程更新FPGA配置的应用中，MCS文件可以更容易地被验证和处理。

5. **适用于复杂配置场景**：在某些FPGA应用中，可能需要复杂的配置管理，比如动态更新配置或多配置启动。MCS格式的文件，由于它们支持的特性，如地址定位和校验，使得这些高级应用成为可能。

总的来说，虽然BIN格式因其简单和直接而在某些情况下是首选，MCS格式通过提供额外的兼容性、校验和管理能力，为FPGA的配置和后期管理提供了更高层次的灵活性和可靠性。选择哪种格式取决于您的具体需求、目标应用以及您所使用的硬件和软件工具链。



## 固件的上电加载过程

1. **上电初始化**：FPGA上电后，会根据其启动模式配置引脚的设置来决定其配置过程的来源。这些设置决定了FPGA是从外部JTAG接口、内置的非易失性存储器，还是外部的非易失性存储设备（如SPI FLASH）加载配置数据。

2. **加载配置位流**：一旦确定了配置数据的来源，FPGA就会尝试从该来源读取配置位流。这个位流是一个二进制文件，它描述了如何在FPGA的可编程逻辑单元中设置逻辑门和连接，以实现所需的电路功能。

3. **配置过程**：在读取位流期间，FPGA内部的配置逻辑会解析这个位流，并据此配置其内部资源（如逻辑块、输入/输出块和路由资源）。这个过程涉及到根据位流中的指令，设置内部的通断状态，从而实现特定的逻辑功能。

需要注意的是，**MCS是在FPGA配置之前，用于存储和传输配置数据的一种文件格式**。如果配置数据以MCS格式存储在FLASH中，那么在将其写入FLASH之前，通常会使用专门的工具将MCS文件转换成FPGA能够直接理解的二进制位流格式。这个转换过程涉及到从MCS文件中提取实际的配置位流，并可能包括校验和地址解析等步骤。

然而，FPGA本身并不“理解”MCS或其他文件格式；它只是按照预定的流程读取并加载位流数据。

### 使用不同地址的固件

1. **通过引导加载器或启动代码**：如果配置数据不在FLASH的起始位置，通常需要一个引导加载器或启动代码来首先被加载。这个引导加载器位于FLASH的起始位置，其任务是指示FPGA如何找到并加载位于非起始位置的配置数据。这意味着，引导加载器首先被加载，然后它负责从FLASH中的其他位置读取实际的配置固件并启动FPGA。

2. **使用间接配置**：在某些情况下，也可以使用间接配置方法，其中一个外部控制器（如微控制器）负责将配置数据从FLASH传输到FPGA。这种情况下，外部控制器可以从FLASH的任意位置读取数据，因为控制器软件可以指定开始读取的确切地址。

### 地址标记和元数据

对于MCS文件，可以在文件中指定数据应该被放置在FLASH中的特定位置。这通常通过在生成MCS文件时包含的地址信息来实现，而程序设备的工具（如Vivado等）会根据这些信息将数据正确地放置在指定的地址。因此，如果配置流程或引导加载器知道正确的地址，并且能够从那个地址开始读取配置数据，FPGA就可以被正确配置，即使数据不在FLASH的物理起始位置。

总结，FPGA不会自动“认为”FLASH中没有固件仅仅因为固件不在地址开始的位置，但这需要适当的配置流程或引导机制来确保FPGA能够找到并加载这些位于非标准位置的固件。


## FLASH的要求

在生成MCS文件时，遇到的SPIx1、SPIx2、SPIx4这类选项，指的是串行外设接口（Serial Peripheral Interface, SPI）的数据传输宽度。这些选项表示FPGA或其他目标设备与非易失性存储设备（如SPI Flash）之间数据传输时使用的线数量，进而影响数据传输的速度和效率。让我们来详细了解一下每种模式：

- **SPIx1**：这是最基本的SPI通信模式，使用单线（Single Line）传输数据，即在单个数据线上顺序传输数据位。在这种模式下，数据的读写速度是这三种模式中最慢的，因为每个时钟周期只能传输1位数据。

- **SPIx2**：双线（Dual Line）模式，在两条数据线上同时传输数据，能够比单线模式提供更高的传输速度。在这种模式下，每个时钟周期可以传输2位数据。

- **SPIx4**：四线（Quad Line）模式，使用四条数据线同时传输数据，提供了比单线和双线更快的数据传输速度。在这种模式下，每个时钟周期可以传输4位数据。

### 如何选择

选择这些模式时，您应该考虑以下几个因素：

1. **硬件支持**：首先需要确保您的FPGA和SPI Flash都支持您想要使用的SPI模式。不是所有的Flash存储器或FPGA都支持双线或四线传输。

2. **传输速度需求**：如果您的应用需要快速配置FPGA或频繁地读取Flash存储器中的数据，使用SPIx4模式可以显著减少数据传输时间。然而，如果速度不是主要考虑因素，SPIx1或SPIx2可能就足够了。

3. **设计复杂性**：更高的传输模式可能会增加设计的复杂性，因为您需要确保所有相关的硬件组件都能够正确支持所选择的模式。例如，SPIx4模式需要更多的引脚和可能更复杂的布线。

4. **电源消耗**：更高的传输速度可能会导致更高的电源消耗，这在电池供电的应用中可能是一个重要的考虑因素。

综上所述，选择适当的SPI模式需要综合考虑您的硬件兼容性、速度需求、设计复杂性和电源消耗等因素。通常情况下，SPIx4由于其高效的数据传输能力而被优先考虑，但只有在所有组件都支持且没有其他限制时才会使用。


## MT25QL256
Micron的MT25QL256是一款常用的NOR Flash存储器，它支持多种SPI操作模式，包括标准SPI、双SPI（Dual SPI）和四SPI（Quad SPI）。

QIO-SPI（Quad I/O SPI）指的是四线SPI（Serial Peripheral Interface），其中“QIO”代表四倍输入/输出。这种模式是SPI通信的一种扩展，允许数据在四条独立的数据线上同时传输，从而显著提高了数据传输速率。

在标准的SPI通信中，数据通过单个数据线（MISO和MOSI）序列传输。而在QIO-SPI模式下，使用四条数据线（通常称为IO0、IO1、IO2、IO3）同时进行数据的读写操作，这使得每个时钟周期内可以传输更多的数据位。